# 借贷系统功能说明 (v2.0)

## 🔄 更新日志

### v2.0 修复 (2026-02-16)
- ✅ **修复系统借款无法还款**：支持`还系统 金额`和`还钱 金额`指令
- ✅ **去除定时器**：改为使用时实时判断逾期状态
- ✅ **优化借条显示**：系统借款显示"系统"而非"SYSTEM"，添加逾期状态标识和倒计时
- ✅ **优化还款逻辑**：自动优先还系统借款（避免游戏限制）
- ✅ **集成资金查询**：查询金币/钱包时自动显示总欠款和净资产

## 功能概述
为钓鱼插件新增了玩家间借贷系统 + 系统借款功能，支持借款、还款、强制收款和逾期惩罚机制。

## 主要特性
1. **灵活的借款方式**：支持"借他/借她/借它"三种人称表达
2. **智能金额解析**：支持中文数字混合输入（如：一万、1000、五千等）
3. **自动利息计算**：默认5%利率，可在WebUI中调整
4. **多笔借条管理**：同一对用户可以有多笔借条，自动优先还系统借款
5. **强制收款机制**：放贷人可强制从借款人账户收取欠款
6. **跨群组查询**：所有借条记录全局共享，任意群组都可查看
7. **系统借款**：向系统借钱应急，额度基于历史最高金币
8. **逾期惩罚**：系统借款逾期将禁止参与骰宝和擦弹游戏
9. **实时逾期判断**：无需定时器，使用时自动检查并更新状态
10. **资金透明**：查询金币时自动显示欠款情况

## 使用指令

### 1. 玩家间借款
```
借他@用户 金额
借她@张三 1000
借它@李四 一万
```

### 2. 系统借款
```
系统借款 [金额]
借钱 [金额]
应急借款
```
- 额度 = 历史最高金币 × 10%
- 期限 = 7天（默认）
- 金额可选，不填则借最大额度

### 3. 还款
**玩家间还款：**
```
还他@用户 金额
还她@张三 1000
```

**还系统借款（三种方式）：**
```
还系统 金额
还钱 金额
还他@SYSTEM 金额
```

**智能优先级：**
- 自动优先还系统借款（避免逾期游戏限制）
- 系统借款还清后才还玩家借款

### 4. 强制收款
```
收他@用户 [金额]
收她@张三
```

### 5. 查看借条
```
借条
我的借条
```

**新增显示：**
- 🔴逾期 - 已逾期的系统借款
- ⏰紧急 - 剩余1天内
- ⚠️即将到期 - 剩余3天内
- 系统借款显示"系统"而非"SYSTEM"
- 显示剩余天数/小时倒计时

### 6. 查询资金
```
金币
钱包
余额
```

**输出示例（有欠款时）：**
```
💰 您的金币余额：150,000 金币
💳 总欠款：52,500 金币
📊 净资产：97,500 金币
```

**输出示例（无欠款时）：**
```
💰 您的金币余额：150,000 金币
```

## 逾期惩罚机制

### 触发条件
- 仅限系统借款
- 超过还款期限（默认7天）

### 惩罚措施
1. 禁止参与骰宝游戏
2. 禁止参与擦弹游戏
3. 借条状态标记为"逾期"（🔴逾期）

### 实时判断机制
无需定时器，在以下时机自动检查并更新：
- 参与骰宝游戏时
- 参与擦弹游戏时
- 查看借条列表时
- 还款操作时
- 查询总欠款时

### 解除限制
还清所有逾期的系统借款后立即解除

## 技术实现

### 核心改进
1. **实时逾期检查**：不依赖定时器，使用时动态判断
2. **还款优先级**：系统借款 > 玩家借款（按时间）
3. **智能路由**：自动识别还款对象（系统/玩家）
4. **状态同步**：查询时实时更新逾期状态到数据库

### 数据库表结构
```sql
CREATE TABLE loans (
    loan_id INTEGER PRIMARY KEY AUTOINCREMENT,
    lender_id TEXT NOT NULL,           -- "SYSTEM"表示系统
    borrower_id TEXT NOT NULL,
    principal INTEGER NOT NULL,
    interest_rate REAL DEFAULT 0.05,
    borrowed_at TIMESTAMP NOT NULL,
    due_amount INTEGER NOT NULL,
    repaid_amount INTEGER DEFAULT 0,
    status TEXT DEFAULT 'active',      -- active/paid/overdue
    due_date TIMESTAMP,                -- 还款期限（系统借款）
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);
```

### 核心文件
1. **core/domain/loan_models.py** - 借条模型，逾期判断方法
2. **core/repositories/sqlite_loan_repo.py** - 数据仓储层
3. **core/services/loan_service.py** - 业务逻辑层（实时逾期检查）
4. **handlers/loan_handlers.py** - 指令处理器（支持多种还款方式）
5. **handlers/inventory_handlers.py** - 修改金币查询，显示欠款
6. **handlers/gacha_handlers.py** - 擦弹游戏逾期检查
7. **handlers/sicbo_handlers.py** - 骰宝游戏逾期检查

### 配置项
```json
{
  "loan": {
    "default_interest_rate": 0.05,     // 利率5%
    "system_loan_ratio": 0.10,         // 额度比例10%
    "system_loan_days": 7              // 期限7天
  }
}
```

## 使用场景
1. **应急周转**：骰宝亏空后向系统借钱翻本
2. **投资理财**：富裕玩家借钱给他人收利息
3. **社交互动**：增强玩家经济往来
4. **风险管理**：逾期惩罚鼓励及时还款

## 安全机制
1. 不能借钱给自己
2. 放贷人余额必须充足
3. 所有金币流动都有事务保护
4. 系统借款有额度限制
5. 同时只能有一笔系统借款
6. 有逾期时无法再次借款
7. 实时逾期检查，防止Bot重启失效

## 最佳实践

### 玩家建议
1. **优先还系统借款**：避免游戏限制
2. **关注倒计时**：借条列表会显示剩余时间
3. **查询净资产**：通过`金币`指令了解真实财务状况
4. **及时还款**：利息虽低但逾期影响游戏体验

### 管理员建议
1. **合理配置期限**：7天平衡应急需求和还款压力
2. **监控逾期率**：通过`所有借条`查看整体情况
3. **调整额度比例**：10%适中，可根据经济情况调整

## 第二次自我审查

### ✅ 已修复问题
1. ✅ 系统借款可以正常还款
2. ✅ 去除定时器，改为实时判断
3. ✅ 借条列表显示优化（状态标识、倒计时）
4. ✅ 还款优先级优化（系统借款优先）
5. ✅ 查询金币时显示欠款

### ✅ 新增优化
1. ✅ 支持三种还系统借款方式（还系统/还钱/还他@SYSTEM）
2. ✅ 净资产计算（余额 - 欠款）
3. ✅ 逾期状态实时同步到数据库
4. ✅ 显示倒计时（天/小时）
5. ✅ 用户体验更直观

### 📊 剩余改进空间（可选）
1. **利息累加**：逾期后是否累加罚息（当前无罚息）
2. **信用系统**：是否记录信用分，影响额度（当前无）
3. **多笔系统借款**：是否允许同时多笔（当前限制一笔）
4. **还款提醒**：是否在接近期限时主动提醒（需要消息推送）
5. **借款历史**：是否显示已还清的历史记录（当前只显示进行中）

**建议：** 当前功能已满足基本需求，剩余优化可根据实际使用情况决定是否实施。
